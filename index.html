<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Air Coin App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      /* Custom Animations */
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .coin-icon {
        animation: float 3s ease-in-out infinite;
      }
      
      /* Theme Variables handled by body classes via JS */
      .theme-boom { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
      .theme-boom .card { border-top: 4px solid #fbbf24; } /* Gold/Happy */
      
      .theme-recession { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
      .theme-recession .card { border-top: 4px solid #60a5fa; } /* Blue/Cool */
      
      .theme-normal { background-color: #f3f4f6; }
      .theme-normal .card { border-top: 4px solid #10b981; } /* Green/Normal */
      
      /* Loader */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  
  <!-- „Çµ„Éº„Éê„ÉºÂÅ¥„ÅßÂà§ÂÆö„Åó„Åü„ÉÜ„Éº„Éû„Çí„ÇØ„É©„Çπ„Å´ÈÅ©Áî® -->
  <!-- GASÁí∞Â¢ÉÂ§ñ„Åß„ÅØÂàùÊúüÂÄ§„Å®„Åó„Å¶theme-normal„ÇíÈÅ©Áî® -->
  <body class="min-h-screen pb-20 theme-normal">
    
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
      <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <i class="fa-solid fa-coins text-yellow-500 text-xl coin-icon"></i>
          <h1 class="font-bold text-gray-800">Air Coin</h1>
        </div>
        <div class="flex items-center space-x-2">
          <span class="text-xs text-gray-500" id="userDept">Loading...</span>
          <div class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm font-bold">
            <i class="fa-solid fa-wallet mr-1"></i><span id="walletBalance">--</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 space-y-6">
      
      <!-- User Status Card -->
      <div class="card bg-white rounded-xl shadow p-4">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-lg font-bold text-gray-800" id="userName">User Name</h2>
            <div class="flex items-center mt-1 space-x-2">
              <span class="text-sm bg-gray-100 px-2 py-0.5 rounded text-gray-600" id="userRank">„É©„É≥„ÇØ: --</span>
              <span class="text-xs text-gray-400">Á¥ØË®àÁç≤Âæó: <span id="lifetimeReceived">--</span></span>
            </div>
          </div>
          <div class="text-center" id="economyIndicator">
             <span class="text-xs font-bold text-green-500">üå± ÈÄöÂ∏∏</span>
          </div>
        </div>
      </div>

      <!-- Send Coin Form -->
      <div class="card bg-white rounded-xl shadow p-6">
        <h3 class="font-bold text-gray-700 mb-4 flex items-center">
          <i class="fa-regular fa-paper-plane mr-2"></i> „Ç≥„Ç§„É≥„ÇíÈÄÅ„Çã
        </h3>
        
        <form id="sendForm" onsubmit="handleSend(event)">
          <!-- Recipient Select -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">„Å†„Çå„Å´Ôºü</label>
            <select id="recipientSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white" required onchange="updateCostDisplay()">
              <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
              <!-- Options will be populated by JS -->
            </select>
          </div>

          <!-- Cost Indicator -->
          <div id="costInfo" class="mb-4 hidden">
            <div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center text-sm">
              <span class="text-blue-800" id="deptRelationText">Èñ¢‰øÇÊÄß</span>
              <span class="font-bold text-blue-800">Ê∂àË≤ª: <span id="costValue">--</span> Êûö</span>
            </div>
          </div>

          <!-- Message -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">„É°„ÉÉ„Çª„Éº„Ç∏ (ÊÑüË¨ù„ÇÑÁß∞Ë≥õ)</label>
            <textarea id="messageInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="„ÅÑ„Å§„ÇÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ" required></textarea>
          </div>

          <!-- Submit Button -->
          <button type="submit" id="submitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform active:scale-95 flex justify-center items-center">
            <span>„Ç≥„Ç§„É≥„ÇíÈÄÅ„Çã</span>
            <i class="fa-solid fa-gift ml-2"></i>
          </button>
        </form>
      </div>
      
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center text-sm whitespace-nowrap">
      <span id="toastMessage">Notification</span>
    </div>
    
    <!-- Modal Overlay for Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white p-5 rounded-lg flex flex-col items-center">
        <div class="loader mb-3"></div>
        <p class="text-gray-700 font-bold">ÈÄÅ‰ø°‰∏≠...</p>
      </div>
    </div>

    <script>
      // --- MOCK GOOGLE SCRIPT RUN (For Local Preview) ---
      // GASÁí∞Â¢ÉÂ§ñÔºà„Éó„É¨„Éì„É•„ÉºÔºâ„ÅßÂãï‰Ωú„Åï„Åõ„Çã„Åü„ÇÅ„ÅÆ„É¢„ÉÉ„ÇØ
      if (typeof google === 'undefined') {
        console.warn('GASÁí∞Â¢ÉÂ§ñ„ÅÆ„Åü„ÇÅ„ÄÅgoogle.script.run„Çí„É¢„ÉÉ„ÇØÂåñ„Åó„Åæ„Åô„ÄÇ');
        window.google = {
          script: {
            run: {
              withSuccessHandler: function(successHandler) {
                this._success = successHandler;
                return this;
              },
              withFailureHandler: function(failureHandler) {
                this._failure = failureHandler;
                return this;
              },
              getInitialData: function() {
                console.log("[Mock] getInitialData called");
                setTimeout(() => {
                  if (this._success) {
                    this._success({
                      user: {
                        name: "Â±±Áî∞ Â§™ÈÉé (Preview)",
                        department: "Âñ∂Ê•≠ÈÉ®",
                        rank: "‰∏ÄËà¨",
                        wallet_balance: 100,
                        lifetime_received: 150,
                        user_id: "yamada@example.com"
                      },
                      userList: [
                        { email: "suzuki@example.com", name: "Èà¥Êú® ‰∏ÄÈÉé", department: "Âñ∂Ê•≠ÈÉ®" },
                        { email: "sato@example.com", name: "‰ΩêËó§ Ëä±Â≠ê", department: "ÈñãÁô∫ÈÉ®" },
                        { email: "tanaka@example.com", name: "Áî∞‰∏≠ Ê¨°ÈÉé", department: "‰∫∫‰∫ãÈÉ®" }
                      ],
                      economy: "normal" 
                    });
                  }
                }, 600);
              },
              sendAirCoin: function(email, message) {
                console.log(`[Mock] sendAirCoin called. To: ${email}, Msg: ${message}`);
                setTimeout(() => {
                  if (this._success) {
                    this._success({
                      success: true,
                      message: "„ÄêMock„ÄëÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅÔºà„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉâÔºâ",
                      newBalance: 90
                    });
                  }
                }, 1000);
              }
            }
          }
        };
      }
      // --------------------------------------------------

      // --- Client Side Logic ---
      
      let currentUser = null;
      let userList = [];
      const COST_SAME = 1;
      const COST_DIFF = 10;

      // ÂàùÊúüÂåñÂá¶ÁêÜ
      window.onload = function() {
        google.script.run
          .withSuccessHandler(initSuccess)
          .withFailureHandler(showError)
          .getInitialData();
      };

      function initSuccess(data) {
        currentUser = data.user;
        userList = data.userList;
        
        // UIÊõ¥Êñ∞
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userDept').textContent = currentUser.department;
        document.getElementById('userRank').textContent = `„É©„É≥„ÇØ: ${currentUser.rank}`;
        document.getElementById('walletBalance').textContent = currentUser.wallet_balance;
        document.getElementById('lifetimeReceived').textContent = currentUser.lifetime_received;
        
        // „ÉÜ„Éº„Éû„ÉªÊôØÊ∞óË°®Á§∫„ÅÆÊõ¥Êñ∞
        updateTheme(data.economy);

        // „Çª„É¨„ÇØ„Éà„Éú„ÉÉ„ÇØ„ÇπÁîüÊàê
        const select = document.getElementById('recipientSelect');
        // ÈÉ®ÁΩ≤„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
        const depts = [...new Set(userList.map(u => u.department))];
        
        depts.forEach(dept => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = dept;
          
          const deptUsers = userList.filter(u => u.department === dept);
          deptUsers.forEach(u => {
            const option = document.createElement('option');
            option.value = u.email;
            option.text = u.name;
            option.dataset.dept = u.department;
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });
      }
      
      function updateTheme(economy) {
        // Body„ÇØ„É©„Çπ„ÅÆÊõ¥Êñ∞
        const body = document.body;
        body.classList.remove('theme-boom', 'theme-recession', 'theme-normal');
        body.classList.add(`theme-${economy}`);
        
        // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÊõ¥Êñ∞
        const indicator = document.getElementById('economyIndicator');
        if (economy === 'boom') {
          indicator.innerHTML = '<span class="text-xs font-bold text-red-500 animate-pulse">üî• Â•ΩÊôØÊ∞ó</span>';
        } else if (economy === 'recession') {
          indicator.innerHTML = '<span class="text-xs font-bold text-blue-500">‚ùÑÔ∏è ÂÅúÊªû‰∏≠</span>';
        } else {
          indicator.innerHTML = '<span class="text-xs font-bold text-green-500">üå± ÈÄöÂ∏∏</span>';
        }
      }

      // „Ç≥„Çπ„ÉàË°®Á§∫Êõ¥Êñ∞
      function updateCostDisplay() {
        const select = document.getElementById('recipientSelect');
        const costInfo = document.getElementById('costInfo');
        
        if (!select.value) {
          costInfo.classList.add('hidden');
          return;
        }
        
        const selectedOption = select.options[select.selectedIndex];
        const targetDept = selectedOption.dataset.dept;
        const isSame = targetDept === currentUser.department;
        
        const cost = isSame ? COST_SAME : COST_DIFF;
        const text = isSame ? 'Âêå„ÅòÈÉ®ÁΩ≤ („ÅäÂæó)' : '‰ªñÈÉ®ÁΩ≤ (ÊÑüË¨ù„Éû„Ç∑„Éû„Ç∑)';
        
        document.getElementById('costValue').textContent = cost;
        document.getElementById('deptRelationText').textContent = text;
        costInfo.classList.remove('hidden');
      }

      // ÈÄÅ‰ø°Âá¶ÁêÜ
      function handleSend(e) {
        e.preventDefault();
        
        const email = document.getElementById('recipientSelect').value;
        const message = document.getElementById('messageInput').value;
        
        if(!email || !message) return;
        
        // UI Loading
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.getElementById('submitBtn').disabled = true;

        google.script.run
          .withSuccessHandler(sendSuccess)
          .withFailureHandler(sendFailure)
          .sendAirCoin(email, message);
      }

      function sendSuccess(result) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('submitBtn').disabled = false;
        
        if (result.success) {
          showToast(result.message);
          // „Éï„Ç©„Éº„É†„ÇØ„É™„Ç¢
          document.getElementById('sendForm').reset();
          document.getElementById('costInfo').classList.add('hidden');
          // ÊÆãÈ´òÊõ¥Êñ∞
          document.getElementById('walletBalance').textContent = result.newBalance;
          currentUser.wallet_balance = result.newBalance; // „É≠„Éº„Ç´„É´Â§âÊï∞„ÇÇÊõ¥Êñ∞
        } else {
          alert(result.message); // ÈáçË¶Å„Å™„Ç®„É©„Éº„ÅØAlert„ÅßÁ¢∫ÂÆü„Å´Ë¶ã„Åõ„Çã
        }
      }

      function sendFailure(error) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('submitBtn').disabled = false;
        showError(error);
      }

      // „Éà„Éº„Çπ„ÉàË°®Á§∫
      function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = msg;
        toast.classList.remove('opacity-0');
        setTimeout(() => {
          toast.classList.add('opacity-0');
        }, 3000);
      }

      function showError(error) {
        console.error(error);
        alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    </script>
  </body>
</html>
