<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>E-yan Coin App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
      .coin-anim { animation: float 3s ease-in-out infinite; }
      body { transition: background 0.5s ease; background-color: #f3f4f6; padding-bottom: 90px; }
      .hidden { display: none !important; }

      /* é€ä¿¡æ¼”å‡º: ã‚³ã‚¤ãƒ³ãƒ»ãƒãƒ¼ãƒˆãŒé™ã‚Šæ³¨ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      @keyframes fall {
        0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
      }
      .celebration-emoji {
        position: fixed;
        font-size: 2rem;
        pointer-events: none;
        z-index: 9999;
        animation: fall linear forwards;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6366f1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .tab-active { color: #4f46e5; }
      .tab-inactive { color: #9ca3af; }
      .bg-boom { background-color: #fffbeb; }
      .bg-depression { background-color: #f1f5f9; }
      .fab-btn {
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 40;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </head>
  
  <body class="min-h-screen text-gray-800 font-sans">
    
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm shadow-sm sticky top-0 z-40">
      <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-coins text-yellow-500 text-2xl coin-anim"></i>
          <h1 class="font-bold text-lg text-gray-800">E-yan Coin</h1>
        </div>
        <div id="headerWallet" class="hidden">
          <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-bold shadow-sm flex items-center">
            <i class="fa-solid fa-wallet mr-2 text-sm"></i>
            <span id="walletBalance">0</span>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

      <!-- VIEW: èªè¨¼ -->
      <div id="view-auth" class="flex flex-col items-center justify-center pt-10 space-y-8">
        <div class="text-center space-y-2">
          <div class="bg-white p-4 rounded-full shadow-md inline-block mb-4">
            <i class="fa-solid fa-handshake-simple text-5xl text-indigo-500"></i>
          </div>
          <h2 class="text-2xl font-bold text-gray-800">æ„Ÿè¬ã‚’ä¼ãˆã‚ˆã†</h2>
          <p class="text-gray-500 text-sm">å¤§é˜ªæ”¯ç¤¾ ã‚³ã‚¤ãƒ³é€é‡‘ã‚¢ãƒ—ãƒª</p>
        </div>
        <button onclick="handleLoginClick()" class="w-full max-w-xs bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition active:scale-95">
          <i class="fa-solid fa-right-to-bracket mr-2"></i> ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
      </div>

      <!-- VIEW: ç™»éŒ² -->
      <div id="view-register" class="hidden">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-6">æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h2>
          <form onsubmit="handleRegister(event)" class="space-y-6">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">ãŠåå‰</label>
              <input type="text" name="name" required placeholder="ä¾‹: å±±ç”° å¤ªéƒ" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">æ‰€å±éƒ¨ç½²</label>
              <select name="department" id="registerDeptSelect" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
              </select>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg">ç™»éŒ²ã™ã‚‹</button>
          </form>
        </div>
      </div>

      <!-- VIEW: ãƒ¡ã‚¤ãƒ³ -->
      <div id="view-app" class="hidden">
        
        <button onclick="switchTab('tab-send')" class="fab-btn bg-gradient-to-r from-indigo-500 to-purple-600 text-white w-14 h-14 rounded-full flex items-center justify-center transition transform hover:scale-110 active:scale-95">
           <i class="fa-regular fa-paper-plane text-2xl"></i>
        </button>

        <!-- TAB 1: ãƒ›ãƒ¼ãƒ  -->
        <div id="tab-home" class="space-y-6">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 relative overflow-hidden">
            <div class="relative z-10">
              <div class="flex justify-between items-start mb-2">
                <div>
                   <p class="text-xs text-gray-500 mb-1" id="userDept">--</p>
                   <h2 class="text-xl font-bold" id="userName">--</h2>
                </div>
                <div class="flex flex-col items-end gap-2">
                  <div class="flex items-center bg-indigo-50 px-2 py-1 rounded-lg">
                    <span id="rankAvatar" class="text-xl mr-1">ğŸ¥º</span>
                    <span class="text-xs font-bold text-indigo-700" id="userRank">ç´ æµªäºº</span>
                    <span id="mvpCrown" class="hidden ml-1">ğŸ‘‘</span>
                  </div>
                  <button onclick="handleSettings()" class="text-gray-400 hover:text-indigo-600 transition">
                    <i class="fa-solid fa-gear text-lg"></i>
                  </button>
                </div>
              </div>
              
              <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <p class="text-xs text-gray-500 mb-1">ä»Šæœˆã®æ™¯æ°— (å…¨ç¤¾æµé€šé‡)</p>
                <div class="flex items-center gap-2">
                  <span id="economyIcon" class="text-3xl">ğŸ </span>
                  <span id="economyText" class="font-bold text-gray-700 text-sm">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
              </div>

              <div class="mt-5">
                 <div class="flex justify-between text-xs font-bold mb-1">
                   <span class="text-gray-500">é…ã‚‹ç”¨ã‚³ã‚¤ãƒ³æ®‹é«˜</span>
                   <span id="progressText" class="text-indigo-600">ã‚ã¨--æšï¼</span>
                 </div>
                 <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                   <div id="coinProgressBar" class="h-full rounded-full transition-all duration-500" style="width: 100%"></div>
                 </div>
                 <p class="text-[10px] text-gray-400 mt-1 text-right">æ¯æœˆ1æ—¥ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ä½¿ã„åˆ‡ã‚ã†ï¼</p>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-start">
             <i class="fa-solid fa-circle-info text-blue-500 mt-1 mr-3"></i>
             <div>
               <h3 class="font-bold text-blue-800 text-sm">ä»–éƒ¨ç½²ã¸ã¯10å€ãƒœãƒ¼ãƒŠã‚¹ï¼</h3>
               <p class="text-xs text-blue-600 mt-1">ç•°ãªã‚‹éƒ¨ç½²ã®äººã«é€ã‚‹ã¨ã€ã‚ãªãŸã®æ¶ˆè²»ã¯ãã®ã¾ã¾ã§ã€ç›¸æ‰‹ã«ã¯<span class="font-bold underline">10å€ã®ä¾¡å€¤</span>ãŒå±Šãã¾ã™ã€‚</p>
             </div>
          </div>
        </div>

        <!-- TAB 2: é€ã‚‹ -->
        <div id="tab-send" class="hidden space-y-4">
          <div class="bg-white rounded-2xl shadow-sm p-6">
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">1. ç›¸æ‰‹ã‚’é¸ã¶</h3>

            <!-- æœ€è¿‘é€ã£ãŸäºº -->
            <div id="recentRecipientsSection" class="mb-4 hidden">
              <p class="text-xs text-gray-500 mb-2">â±ï¸ æœ€è¿‘é€ã£ãŸäºº</p>
              <div id="recentRecipientsList" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                <!-- ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
              </div>
            </div>

            <div class="mb-4">
              <input type="text" id="recipientSearchInput" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm" placeholder="ğŸ” åå‰ã‚„éƒ¨ç½²ã§æ¤œç´¢..." oninput="handleSearchRecipient()">
            </div>
            <select id="recipientSelect" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl mb-6 appearance-none" onchange="updateEstimatedValue()">
              <option value="">ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</option>
            </select>

            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">2. æšæ•°ã‚’æ±ºã‚ã‚‹</h3>
            <div class="flex items-center gap-4 mb-2">
               <button type="button" onclick="adjustAmount(-10)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200">-</button>
               <input type="number" id="sendAmount" value="10" min="1" class="flex-1 p-3 text-center text-xl font-bold border border-gray-200 rounded-xl" oninput="updateEstimatedValue()">
               <button type="button" onclick="adjustAmount(10)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200">+</button>
            </div>
            
            <div id="estimationArea" class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 mb-6 hidden border border-yellow-100">
               <p><i class="fa-solid fa-calculator mr-1"></i> <span id="estimationText">è¨ˆç®—ä¸­...</span></p>
            </div>

            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
            <textarea id="messageInput" rows="3" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl mb-2" placeholder="åŠ©ã‹ã‚Šã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ï¼(100æ–‡å­—ä»¥å†…)"></textarea>
            
            <div class="flex gap-2 mb-4 overflow-x-auto py-1 scrollbar-hide">
               <button type="button" onclick="addEmoji('ğŸ™')" class="text-xl bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">ğŸ™</button>
               <button type="button" onclick="addEmoji('ğŸ‘')" class="text-xl bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">ğŸ‘</button>
               <button type="button" onclick="addText('ç¥')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg font-bold">ç¥</button>
               <button type="button" onclick="addText('è‰')" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg font-bold">è‰</button>
               <button type="button" onclick="addEmoji('ğŸ”¥')" class="text-xl bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">ğŸ”¥</button>
               <button type="button" onclick="addEmoji('ğŸ™‡')" class="text-xl bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">ğŸ™‡</button>
               <button type="button" onclick="addEmoji('ğŸº')" class="text-xl bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg">ğŸº</button>
            </div>

            <button onclick="handleSend()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md active:bg-indigo-800 transition">
              é€ä¿¡ã™ã‚‹
            </button>
          </div>
        </div>

        <!-- TAB 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
        <div id="tab-ranking" class="hidden space-y-6">
          <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-100">
             <h2 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-building-user mr-2 text-indigo-500"></i>éƒ¨ç½²å¯¾æŠ—åˆæˆ¦</h2>
             <div id="deptRankingChart" class="space-y-3 text-sm">
                <div class="text-center text-gray-400 py-4">é›†è¨ˆä¸­...</div>
             </div>
          </div>

          <div>
            <h2 class="font-bold text-gray-600 mb-2 ml-2"><i class="fa-solid fa-trophy mr-1 text-yellow-500"></i>ä»Šæœˆã®MVP (å—ä¿¡æ•°)</h2>
            <div id="rankingList" class="space-y-3">
               <div class="text-center text-gray-400 py-10">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>

          <div>
            <h2 class="font-bold text-gray-600 mb-2 ml-2"><i class="fa-solid fa-hand-holding-heart mr-1 text-pink-500"></i>ãƒ™ã‚¹ãƒˆã‚®ãƒãƒ¼ (é€ä¿¡æ•°)</h2>
            <div id="giverRankingList" class="space-y-3 pb-20">
               <div class="text-center text-gray-400 py-10">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
        </div>

        <!-- TAB 4: å±¥æ­´ (ãƒã‚¤ãƒšãƒ¼ã‚¸) -->
        <div id="tab-profile" class="hidden space-y-4">
           <div class="bg-white p-4 rounded-xl shadow-sm text-center">
              <p class="text-gray-500 text-xs mb-1">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</p>
              <div class="text-4xl mb-2" id="profileRankAvatar">ğŸ¥º</div>
              <h2 class="font-bold text-lg" id="profileRankName">ç´ æµªäºº</h2>
              <p class="text-xs text-gray-400 mt-2">æ¥æœˆ1æ—¥ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</p>
           </div>
           
           <h2 class="font-bold text-gray-600 ml-2">ç²å¾—å±¥æ­´</h2>
           <div id="historyList" class="space-y-3 pb-20">
             <div class="text-center text-gray-400 py-10">èª­ã¿è¾¼ã¿ä¸­...</div>
           </div>
        </div>

      </div>

    </main>
    
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav id="bottomNav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 pb-safe hidden z-50">
      <div class="max-w-md mx-auto flex justify-around">
        <button onclick="switchTab('tab-home')" class="flex-1 py-3 flex flex-col items-center tab-active" id="nav-home">
          <i class="fa-solid fa-house text-xl mb-1"></i>
          <span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span>
        </button>
        <button onclick="switchTab('tab-send')" class="flex-1 py-3 flex flex-col items-center tab-inactive" id="nav-send">
          <i class="fa-solid fa-gift text-xl mb-1"></i>
          <span class="text-[10px] font-bold">é€ã‚‹</span>
        </button>
        <button onclick="switchTab('tab-ranking')" class="flex-1 py-3 flex flex-col items-center tab-inactive" id="nav-ranking">
          <i class="fa-solid fa-trophy text-xl mb-1"></i>
          <span class="text-[10px] font-bold">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
        </button>
        <button onclick="switchTab('tab-profile')" class="flex-1 py-3 flex flex-col items-center tab-inactive" id="nav-profile">
          <i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i>
          <span class="text-[10px] font-bold">å±¥æ­´</span>
        </button>
      </div>
    </nav>

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 hidden flex flex-col items-center justify-center">
      <div class="loader mb-4"></div>
      <p id="loadingText" class="text-gray-600 font-bold">å‡¦ç†ä¸­...</p>
    </div>

    <script>
      let currentUser = null;
      let loadedDepartments = [];
      let allUserList = [];
      let appConfig = {};

      const RANK_MAP = {
        'ç´ æµªäºº': 'ğŸ¥º',
        'ä¸ç¨š': 'ğŸ£',
        'å•†äºº': 'ğŸ‘˜',
        'è±ªå•†': 'ğŸ¯',
        'å¤©ä¸‹äºº': 'ğŸ‘‘'
      };

      // ãƒ•ãƒ©ã‚°ç®¡ç†
      let isRankingLoaded = false;
      let isHistoryLoaded = false;
      let isSuggestLoaded = false;
      let recentRecipients = [];

      function handleLoginClick() {
        toggleLoading(true);
        google.script.run.withSuccessHandler(onInitSuccess).withFailureHandler(onFailure).getInitialData();
      }

      function onInitSuccess(data) {
        toggleLoading(false);
        if (data.error === 'NOT_REGISTERED') {
          loadedDepartments = data.departments || [];
          generateDeptOptions(loadedDepartments);
          document.getElementById('view-auth').classList.add('hidden');
          document.getElementById('view-register').classList.remove('hidden');
        } else if (data.success) {
          initializeApp(data);
        }
      }

      function initializeApp(data) {
        currentUser = data.user;
        allUserList = data.userList;
        loadedDepartments = data.departments;
        appConfig = data.config;

        updateUserUI();
        
        const ecoMap = {
          'depression': { icon: 'ğŸ¥º ğŸƒ ğŸ’¸', text: 'ä¸æ³... (Lv.1)', bg: 'bg-depression' },
          'normal':     { icon: 'ğŸ™ ğŸ¢ â˜ï¸', text: 'é€šå¸¸é‹è»¢ (Lv.2)', bg: '' },
          'boom':       { icon: 'ğŸ¯ â¤ï¸â€ğŸ”¥ ğŸ‰ ğŸ’°', text: 'æ™¯æ°—ãˆãˆã‚„ã‚“ï¼(Lv.3)', bg: 'bg-boom' }
        };
        const ecoState = ecoMap[data.economy] || ecoMap['normal'];
        document.getElementById('economyIcon').textContent = ecoState.icon;
        document.getElementById('economyText').textContent = ecoState.text;
        if(ecoState.bg) document.body.classList.add(ecoState.bg);
        
        renderRecipientSelect(allUserList);
        
        document.getElementById('view-auth').classList.add('hidden');
        document.getElementById('view-register').classList.add('hidden');
        document.getElementById('view-app').classList.remove('hidden');
        document.getElementById('headerWallet').classList.remove('hidden');
        document.getElementById('bottomNav').classList.remove('hidden');
        
        switchTab('tab-home');
      }

      function updateUserUI() {
        const avatar = RANK_MAP[currentUser.rank] || 'ğŸ¥º';

        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userDept').textContent = currentUser.department;
        document.getElementById('userRank').textContent = currentUser.rank;
        document.getElementById('rankAvatar').textContent = avatar;
        document.getElementById('profileRankName').textContent = currentUser.rank;
        document.getElementById('profileRankAvatar').textContent = avatar;

        // å‰æœˆMVPç‹å† è¡¨ç¤º
        const crownEl = document.getElementById('mvpCrown');
        if (currentUser.isMVP) {
          crownEl.classList.remove('hidden');
          crownEl.title = 'å‰æœˆMVP';
        } else {
          crownEl.classList.add('hidden');
        }
        
        const balance = Number(currentUser.wallet_balance);
        document.getElementById('walletBalance').textContent = balance;
        
        const maxCoin = 1000;
        const percent = Math.min((balance / maxCoin) * 100, 100);
        const bar = document.getElementById('coinProgressBar');
        
        bar.style.width = percent + '%';
        bar.className = 'h-full rounded-full transition-all duration-500 ';
        if (balance > 700) {
           bar.classList.add('bg-red-500');
           document.getElementById('progressText').textContent = `ã‚ã¨${balance}æšé…ã‚‰ãªï¼`;
           document.getElementById('progressText').className = "text-red-500 font-bold";
        } else if (balance > 300) {
           bar.classList.add('bg-yellow-400');
           document.getElementById('progressText').textContent = `ã‚ã¨${balance}æšï¼`;
           document.getElementById('progressText').className = "text-yellow-600 font-bold";
        } else {
           bar.classList.add('bg-green-500');
           document.getElementById('progressText').textContent = `æ®‹ã‚Š${balance}æšã€ãˆãˆæ„Ÿã˜ï¼`;
           document.getElementById('progressText').className = "text-green-600 font-bold";
        }
      }

      // --- ã‚¿ãƒ–åˆ¶å¾¡ (é«˜é€ŸåŒ–: å¿…è¦ãªæ™‚ã ã‘ãƒ­ãƒ¼ãƒ‰) ---
      function switchTab(tabId) {
        ['tab-home', 'tab-send', 'tab-ranking', 'tab-profile'].forEach(id => {
          document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(tabId).classList.remove('hidden');

        const navIds = {
          'tab-home': 'nav-home',
          'tab-send': 'nav-send',
          'tab-ranking': 'nav-ranking',
          'tab-profile': 'nav-profile'
        };
        Object.values(navIds).forEach(navId => {
          const el = document.getElementById(navId);
          el.classList.remove('tab-active');
          el.classList.add('tab-inactive');
        });
        document.getElementById(navIds[tabId]).classList.add('tab-active');
        document.getElementById(navIds[tabId]).classList.remove('tab-inactive');

        // â˜…å¿…è¦ãªæ™‚ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        if (tabId === 'tab-ranking' && !isRankingLoaded) {
          loadRankings();
        } else if (tabId === 'tab-profile' && !isHistoryLoaded) {
          loadHistory();
        } else if (tabId === 'tab-send' && !isSuggestLoaded) {
          loadRecentRecipients();
        }
      }

      function handleSettings() { alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ãƒ»è¨­å®šç”»é¢ã¯æº–å‚™ä¸­ã§ã™ï¼'); }

      function addEmoji(emoji) {
        const input = document.getElementById('messageInput');
        input.value += emoji;
      }

      function addText(text) {
        const input = document.getElementById('messageInput');
        input.value += text;
      }

      function adjustAmount(val) {
        const input = document.getElementById('sendAmount');
        let current = parseInt(input.value) || 0;
        let next = current + val;
        if (next < 1) next = 1;
        input.value = next;
        updateEstimatedValue();
      }

      function updateEstimatedValue() {
        const email = document.getElementById('recipientSelect').value;
        const amount = parseInt(document.getElementById('sendAmount').value) || 0;
        const area = document.getElementById('estimationArea');
        const text = document.getElementById('estimationText');

        if (!email || amount <= 0) {
          area.classList.add('hidden');
          return;
        }

        const target = allUserList.find(u => u.email === email);
        if (!target) return;

        const isSame = target.department === currentUser.department;
        const multiplier = isSame ? 1 : (appConfig.MULTIPLIER_DIFF_DEPT || 10);
        const gained = amount * multiplier;

        area.classList.remove('hidden');
        if (isSame) {
          text.innerHTML = `åŒéƒ¨ç½²: æ¶ˆè²»<b>${amount}</b> â†’ ç›¸æ‰‹ã®å®Ÿç¸¾<b>+${gained}</b>`;
        } else {
          text.innerHTML = `ä»–éƒ¨ç½²ãƒœãƒ¼ãƒŠã‚¹ï¼: æ¶ˆè²»<b>${amount}</b> â†’ ç›¸æ‰‹ã®å®Ÿç¸¾<b>+${gained}</b> (${multiplier}å€!)`;
        }
      }

      function handleSend() {
        const email = document.getElementById('recipientSelect').value;
        const amount = document.getElementById('sendAmount').value;
        const msg = document.getElementById('messageInput').value;

        if (!email || !amount || !msg) { alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (msg.length > 100) { alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯100æ–‡å­—ä»¥å†…ã§ãŠé¡˜ã„ã—ã¾ã™'); return; }
        if(!confirm(`${amount}æšã®ã‚³ã‚¤ãƒ³ã‚’é€ã‚Šã¾ã™ã‹ï¼Ÿ`)) return;

        toggleLoading(true, 'é€ä¿¡ä¸­...');
        google.script.run.withSuccessHandler(res => {
          toggleLoading(false);
          if (res.success) {
            // é€ä¿¡æ¼”å‡ºã‚’å®Ÿè¡Œ
            playCelebration();

            setTimeout(() => {
              alert(res.message);
              currentUser.wallet_balance = res.newBalance;
              updateUserUI();

              // å±¥æ­´ã¨ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã•ã›ã‚‹ãŸã‚ã«ãƒ•ãƒ©ã‚°ã‚’æŠ˜ã‚‹
              isHistoryLoaded = false;
              isSuggestLoaded = false;

              document.getElementById('messageInput').value = '';
              document.getElementById('recipientSearchInput').value = '';
              renderRecipientSelect(allUserList);
              switchTab('tab-home');
            }, 500);
          } else {
            alert(res.message);
          }
        }).withFailureHandler(onFailure).sendAirCoin(email, msg, amount);
      }

      // é€ä¿¡æ¼”å‡º: ã‚³ã‚¤ãƒ³ã¨ãƒãƒ¼ãƒˆãŒé™ã‚Šæ³¨ã
      function playCelebration() {
        const emojis = ['ğŸ’°', 'ğŸª™', 'â¤ï¸', 'ğŸ’–', 'âœ¨', 'ğŸ‰'];
        const count = 20; // é™ã‚‰ã›ã‚‹çµµæ–‡å­—ã®æ•°

        for (let i = 0; i < count; i++) {
          setTimeout(() => {
            const emoji = document.createElement('div');
            emoji.className = 'celebration-emoji';
            emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            emoji.style.left = Math.random() * 100 + '%';
            emoji.style.animationDuration = (2 + Math.random() * 2) + 's';
            emoji.style.animationDelay = '0s';
            document.body.appendChild(emoji);

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤
            setTimeout(() => emoji.remove(), 4000);
          }, i * 100);
        }
      }

      function handleSearchRecipient() {
        const keyword = document.getElementById('recipientSearchInput').value.trim();
        if (!keyword) { renderRecipientSelect(allUserList); return; }
        const filtered = allUserList.filter(u =>
          u.name.indexOf(keyword) !== -1 || u.department.indexOf(keyword) !== -1
        );
        renderRecipientSelect(filtered);
      }

      // æœ€è¿‘é€ã£ãŸäººã‚’èª­ã¿è¾¼ã‚€
      function loadRecentRecipients() {
        google.script.run.withSuccessHandler(res => {
          if (!res.success) return;
          recentRecipients = res.recipients;
          renderRecentRecipients();
          isSuggestLoaded = true;
        }).getRecentRecipients(5);
      }

      // æœ€è¿‘é€ã£ãŸäººã‚’è¡¨ç¤º
      function renderRecentRecipients() {
        if (!recentRecipients || recentRecipients.length === 0) return;

        const container = document.getElementById('recentRecipientsList');
        const section = document.getElementById('recentRecipientsSection');
        container.innerHTML = '';

        recentRecipients.forEach(email => {
          const user = allUserList.find(u => u.email === email);
          if (!user) return;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'px-3 py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold whitespace-nowrap hover:bg-indigo-100 active:scale-95 transition';
          btn.textContent = user.name;
          btn.onclick = () => selectRecipient(email);
          container.appendChild(btn);
        });

        section.classList.remove('hidden');
      }

      // ã‚µã‚¸ã‚§ã‚¹ãƒˆã‹ã‚‰é¸æŠ
      function selectRecipient(email) {
        document.getElementById('recipientSelect').value = email;
        updateEstimatedValue();
      }

      function renderRecipientSelect(users) {
         const select = document.getElementById('recipientSelect');
         select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
         const groups = {};
         users.forEach(u => {
           if(!groups[u.department]) groups[u.department] = [];
           groups[u.department].push(u);
         });
         Object.keys(groups).forEach(dept => {
           const grp = document.createElement('optgroup');
           grp.label = dept;
           groups[dept].forEach(u => {
             const opt = document.createElement('option');
             opt.value = u.email;
             opt.textContent = u.name;
             grp.appendChild(opt);
           });
           select.appendChild(grp);
         });
      }

      // --- èª­ã¿è¾¼ã¿ & æç”» ---

      function loadRankings() {
        const rankList = document.getElementById('rankingList');
        rankList.innerHTML = '<div class="text-center text-gray-400 py-10"><div class="loader mx-auto mb-2 w-6 h-6 border-2"></div>ãƒ©ãƒ³ã‚­ãƒ³ã‚°é›†è¨ˆä¸­...</div>';

        google.script.run.withSuccessHandler(res => {
          if (!res.success) return;
          renderRankings(res.rankings.mvp);
          renderGiverRanking(res.rankings.giver);
          renderDeptRanking(res.rankings.dept);
          isRankingLoaded = true; // ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°
        }).getRankings(); // â˜…åˆ†é›¢ã—ãŸé–¢æ•°ã‚’å‘¼ã¶
      }

      function loadHistory() {
        const histList = document.getElementById('historyList');
        histList.innerHTML = '<div class="text-center text-gray-400 py-10"><div class="loader mx-auto mb-2 w-6 h-6 border-2"></div>å±¥æ­´ã‚’å–å¾—ä¸­...</div>';

        google.script.run.withSuccessHandler(res => {
          if (!res.success) return;
          renderHistory(res.history);
          isHistoryLoaded = true; // ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ•ãƒ©ã‚°
        }).getUserHistory(); // â˜…åˆ†é›¢ã—ãŸé–¢æ•°ã‚’å‘¼ã¶
      }

      function renderRankings(list) {
        const container = document.getElementById('rankingList');
        container.innerHTML = '';
        if (list.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        list.forEach((item, index) => {
           const rankIcon = index < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][index] : `<span class="font-bold text-gray-500 w-6 inline-block text-center">${index+1}</span>`;
           const div = document.createElement('div');
           div.className = "flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100";
           div.innerHTML = `
             <div class="text-xl mr-3">${rankIcon}</div>
             <div class="flex-1">
               <div class="font-bold text-sm">${item.name}</div>
               <div class="text-xs text-gray-400">${item.dept}</div>
             </div>
             <div class="font-bold text-indigo-600">${item.score} pt</div>
           `;
           container.appendChild(div);
        });
      }

      function renderGiverRanking(list) {
        const container = document.getElementById('giverRankingList');
        container.innerHTML = '';
        if (!list || list.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        list.forEach((item, index) => {
           const rankIcon = index < 3 ? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][index] : `<span class="font-bold text-gray-500 w-6 inline-block text-center">${index+1}</span>`;
           const div = document.createElement('div');
           div.className = "flex items-center bg-white p-3 rounded-xl shadow-sm border border-gray-100";
           div.innerHTML = `
             <div class="text-xl mr-3">${rankIcon}</div>
             <div class="flex-1">
               <div class="font-bold text-sm">${item.name}</div>
             </div>
             <div class="font-bold text-pink-600">${item.count} å›</div>
           `;
           container.appendChild(div);
        });
      }

      function renderDeptRanking(list) {
         const container = document.getElementById('deptRankingChart');
         container.innerHTML = '';
         if (!list || list.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-400 text-xs">ãƒ‡ãƒ¼ã‚¿ä¸è¶³</div>';
            return;
         }
         const maxScore = list[0].score || 1;
         list.slice(0, 5).forEach(item => { 
            const percent = (item.score / maxScore) * 100;
            const div = document.createElement('div');
            div.innerHTML = `
               <div class="flex justify-between text-xs mb-1">
                  <span class="font-bold text-gray-700">${item.name}</span>
                  <span class="text-indigo-600 font-bold">${item.score}</span>
               </div>
               <div class="w-full bg-gray-100 rounded-full h-2">
                  <div class="bg-indigo-500 h-2 rounded-full" style="width: ${percent}%"></div>
               </div>
            `;
            container.appendChild(div);
         });
      }

      function renderHistory(list) {
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        if (list.length === 0) {
          container.innerHTML = '<div class="text-center text-gray-400">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        list.forEach(item => {
           const date = new Date(item.timestamp);
           const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
           const div = document.createElement('div');
           div.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden";
           const bonusClass = item.amount < item.value ? 'bg-yellow-50' : '';
           if(bonusClass) div.classList.add(bonusClass);

           div.innerHTML = `
             <div class="flex justify-between items-start mb-2">
               <div>
                 <span class="text-xs text-gray-400">${dateStr}</span>
                 <h4 class="font-bold text-sm text-gray-800">${item.sender_name} <span class="text-xs font-normal text-gray-500">(${item.sender_dept})</span></h4>
               </div>
               <div class="text-right">
                 <div class="font-bold text-indigo-600">+${item.value}</div>
                 ${item.amount < item.value ? '<span class="text-[10px] text-yellow-600 font-bold px-1 border border-yellow-200 rounded">ä»–éƒ¨ç½²BONUS!</span>' : ''}
               </div>
             </div>
             <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">${item.message}</p>
           `;
           container.appendChild(div);
        });
      }

      function handleRegister(e) {
        e.preventDefault();
        const form = e.target;
        if(!confirm('ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
        toggleLoading(true, 'ç™»éŒ²ä¸­...');
        google.script.run.withSuccessHandler(res => {
           if(res.success) {
             alert(res.message);
             handleLoginClick();
           } else {
             toggleLoading(false);
             alert(res.message);
           }
        }).registerNewUser({ name: form.name.value, department: form.department.value });
      }
      
      function generateDeptOptions(list) {
        const select = document.getElementById('registerDeptSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        list.forEach(dept => {
          const opt = document.createElement('option');
          opt.value = dept;
          opt.textContent = dept;
          select.appendChild(opt);
        });
      }

      function toggleLoading(show, msg) {
        const el = document.getElementById('loadingOverlay');
        if(show) {
          if(msg) document.getElementById('loadingText').textContent = msg;
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      }
      function onFailure(e) {
        toggleLoading(false);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    </script>
  </body>
</html>
