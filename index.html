<!DOCTYPE html>
<html lang="ja">
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>E-yan Coin App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
      @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
      .coin-anim { animation: float 3s ease-in-out infinite; }
      @keyframes slideUpFade { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
      .toast-enter { animation: slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
      body { transition: background 0.8s ease; padding-bottom: 100px; overscroll-behavior-y: none; }
      .hidden { display: none !important; }
      .tab-active { color: #4f46e5; }
      .tab-inactive { color: #9ca3af; }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </head>
  
  <body class="min-h-screen text-gray-800 font-sans bg-gray-50">
    
    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center transition-opacity duration-300">
      <div class="loader mb-3"></div>
      <p id="loadingText" class="text-gray-500 text-sm font-bold">èµ·å‹•ä¸­...</p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur-md bg-white/70 shadow-sm border-b border-white/20">
      <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-coins text-yellow-500 text-2xl coin-anim"></i>
          <h1 class="font-bold text-lg text-gray-800 tracking-tight">E-yan Coin</h1>
        </div>
        <div id="headerWallet" class="hidden">
          <div class="bg-yellow-100/80 text-yellow-800 px-3 py-1 rounded-full font-bold shadow-sm flex items-center border border-yellow-200">
            <i class="fa-solid fa-wallet mr-2 text-sm"></i>
            <span id="walletBalance">--</span>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">
      <!-- AUTH VIEW -->
      <div id="view-auth" class="flex flex-col items-center justify-center py-10 space-y-6 hidden">
         <div class="p-6 bg-white rounded-3xl shadow-xl shadow-indigo-100 text-center w-full">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome!</h2>
            <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95">ã¯ã˜ã‚ã‚‹</button>
         </div>
      </div>

      <!-- REGISTER VIEW -->
      <div id="view-register" class="hidden">
        <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-6">åˆå›ç™»éŒ²</h2>
          <form onsubmit="handleRegister(event)" class="space-y-4">
            <div><label class="block text-xs font-bold text-gray-500 mb-1">ãŠåå‰</label><input type="text" name="name" required class="w-full p-3 bg-gray-50 rounded-xl outline-none"></div>
            <div><label class="block text-xs font-bold text-gray-500 mb-1">æ‰€å±éƒ¨ç½²</label><select name="department" id="registerDeptSelect" required class="w-full p-3 bg-gray-50 rounded-xl outline-none"></select></div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-4 shadow-md">ç™»éŒ²ã™ã‚‹</button>
          </form>
        </div>
      </div>

      <!-- MAIN APP VIEW -->
      <div id="view-app" class="hidden">
        <button onclick="switchTab('tab-send')" class="fixed bottom-24 right-5 z-40 bg-gradient-to-r from-indigo-500 to-purple-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition hover:scale-105 active:scale-90"><i class="fa-regular fa-paper-plane text-2xl"></i></button>

        <!-- TAB: HOME -->
        <div id="tab-home" class="space-y-5">
          <div class="bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-white/50 p-5">
            <div class="flex justify-between items-start">
              <div><p class="text-xs text-gray-500 mb-0.5" id="userDept">--</p><h2 class="text-xl font-bold text-gray-800" id="userName">--</h2></div>
              <div class="flex flex-col items-end gap-1">
                <div class="flex items-center bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100">
                  <span id="rankAvatar" class="text-xl mr-1">ğŸ¥º</span><span class="text-xs font-bold text-indigo-700" id="userRank">--</span><span id="mvpCrown" class="hidden ml-1 text-sm">ğŸ‘‘</span>
                </div>
              </div>
            </div>
            <div class="mt-4 p-3 bg-gray-50/80 rounded-xl border border-gray-100 flex items-center justify-between">
              <div><p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Economy Status</p><p class="text-sm font-bold text-gray-700 flex items-center gap-2" id="economyStatusText">--</p></div>
              <div class="text-2xl" id="economyIcon">â˜ï¸</div>
            </div>
            <div class="mt-5">
               <div class="flex justify-between text-xs font-bold mb-1"><span class="text-gray-400">é…å¸ƒå¯èƒ½æ®‹é«˜</span><span id="progressText" class="text-indigo-600">--</span></div>
               <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden"><div id="coinProgressBar" class="h-full bg-indigo-500 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
               <div class="flex justify-between mt-1"><p class="text-[10px] text-gray-400">æœ¬æ—¥é€ä¿¡æ¸ˆã¿: <span id="dailySentCount">0</span>/20æš</p></div>
            </div>
          </div>
          <div class="bg-blue-50/80 border border-blue-100 p-4 rounded-xl flex gap-3"><i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i><div><h3 class="text-sm font-bold text-blue-800">ä»–éƒ¨ç½²ãƒœãƒ¼ãƒŠã‚¹</h3><p class="text-xs text-blue-600 mt-1">é•ã†éƒ¨ç½²ã®äººã«é€ã‚‹ã¨ä¾¡å€¤ãŒ<span class="font-bold underline">1.5å€</span>ï¼</p></div></div>
        </div>

        <!-- TAB: SEND -->
        <div id="tab-send" class="hidden space-y-4">
          <div class="bg-white/90 backdrop-blur rounded-2xl shadow-sm p-5 pb-8">
            <h3 class="text-sm font-bold text-gray-500 mb-3">1. ã ã‚Œã«é€ã‚‹ï¼Ÿ</h3>
            <div class="mb-4"><input type="text" id="recipientSearch" placeholder="åå‰ã‚„éƒ¨ç½²ã§æ¤œç´¢..." class="w-full p-3 bg-gray-50 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-300 transition" oninput="filterRecipients()"></div>
            <select id="recipientSelect" class="w-full p-3 bg-gray-50 border-none rounded-xl mb-6 outline-none appearance-none font-bold text-gray-700" onchange="updateEstimation()"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>

            <h3 class="text-sm font-bold text-gray-500 mb-3">2. ä½•æšé€ã‚‹ï¼Ÿ</h3>
            <div class="flex items-center justify-between bg-gray-50 rounded-xl p-2 mb-2">
               <button onclick="stepAmount(-1)" class="w-12 h-12 bg-white rounded-lg shadow-sm text-gray-600 font-bold"><i class="fa-solid fa-minus"></i></button>
               <div class="text-center"><span id="displayAmount" class="text-3xl font-bold text-indigo-600 font-mono">1</span><span class="text-xs text-gray-400 font-bold block">COINS</span></div>
               <button onclick="stepAmount(1)" class="w-12 h-12 bg-white rounded-lg shadow-sm text-gray-600 font-bold"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="estimationBox" class="hidden bg-yellow-50 border border-yellow-100 rounded-lg p-3 mb-6 text-yellow-800 text-xs font-bold text-center"><i class="fa-solid fa-calculator mr-1"></i><span id="estimationResult">--</span></div>

            <h3 class="text-sm font-bold text-gray-500 mb-3">3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
            <textarea id="messageInput" rows="2" class="w-full p-3 bg-gray-50 border-none rounded-xl mb-2 text-sm outline-none" placeholder="ã‚ã‚ŠãŒã¨ã†ï¼"></textarea>
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide mb-4">
              <button type="button" onclick="addTag('ğŸ™ ã‚ã‚ŠãŒã¨ã†')" class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold">ğŸ™ ã‚ã‚ŠãŒã¨ã†</button>
              <button type="button" onclick="addTag('ğŸ‘ ã•ã™ãŒ')" class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold">ğŸ‘ ã•ã™ãŒ</button>
            </div>
            <button onclick="submitSend()" id="sendBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg transition disabled:opacity-50">é€ä¿¡ã™ã‚‹</button>
          </div>
        </div>

        <!-- TAB: RANKING -->
        <div id="tab-ranking" class="hidden space-y-6">
           <div class="bg-white/80 backdrop-blur rounded-2xl shadow-sm p-4"><h2 class="font-bold text-gray-700 mb-4 text-sm">ä»Šæœˆã®MVP</h2><div id="mvpList" class="space-y-3 min-h-[100px] text-center text-xs text-gray-400 py-4">èª­ã¿è¾¼ã¿ä¸­...</div></div>
           <div class="bg-white/80 backdrop-blur rounded-2xl shadow-sm p-4"><h2 class="font-bold text-gray-700 mb-4 text-sm">éƒ¨ç½²å¯¾æŠ—</h2><div id="deptList" class="space-y-3 min-h-[50px]"></div></div>
        </div>

        <!-- TAB: HISTORY -->
        <div id="tab-history" class="hidden space-y-4"><h2 class="text-lg font-bold text-gray-700 px-2">å±¥æ­´</h2><div id="historyContainer" class="space-y-3 pb-20"><div class="text-center text-xs text-gray-400 py-10">èª­ã¿è¾¼ã¿ä¸­...</div></div></div>
      </div>
    </main>

    <nav id="bottomNav" class="fixed bottom-0 w-full bg-white/90 backdrop-blur border-t border-gray-200 pb-safe hidden z-50">
      <div class="flex justify-around items-center max-w-md mx-auto">
        <button onclick="switchTab('tab-home')" id="nav-home" class="flex-1 py-3 flex flex-col items-center tab-active"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-bold">ãƒ›ãƒ¼ãƒ </span></button>
        <button onclick="switchTab('tab-send')" id="nav-send" class="flex-1 py-3 flex flex-col items-center tab-inactive"><i class="fa-solid fa-paper-plane text-xl mb-1"></i><span class="text-[10px] font-bold">é€ã‚‹</span></button>
        <button onclick="switchTab('tab-ranking')" id="nav-ranking" class="flex-1 py-3 flex flex-col items-center tab-inactive"><i class="fa-solid fa-chart-simple text-xl mb-1"></i><span class="text-[10px] font-bold">ãƒ©ãƒ³ã‚¯</span></button>
        <button onclick="switchTab('tab-history')" id="nav-history" class="flex-1 py-3 flex flex-col items-center tab-inactive"><i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i><span class="text-[10px] font-bold">å±¥æ­´</span></button>
      </div>
    </nav>
    <div id="toast" class="fixed bottom-24 left-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-xl shadow-2xl z-[100] hidden flex items-center justify-between"><div class="flex items-center gap-3"><i class="fa-solid fa-circle-check text-green-400 text-xl"></i><div class="text-sm"><p class="font-bold" id="toastTitle">Success</p><p class="text-xs text-gray-300" id="toastMsg">å‡¦ç†å®Œäº†</p></div></div></div>

    <script>
      // Mock Data (GASç’°å¢ƒå¤–ç”¨)
      if (typeof google === 'undefined') {
         console.warn('Mock Mode');
         window.google = { script: { run: {
            withSuccessHandler: function(f) { this.s=f; return this; },
            withFailureHandler: function(f) { this.f=f; return this; },
            getInitialData: function() { setTimeout(()=>this.s({success:true, user:{name:'Mock User',department:'å–¶æ¥­éƒ¨',rank:'å•†äºº',wallet_balance:80,dailySent:5}, economy:'level2', config:{MULTIPLIER_DIFF_DEPT:1.5}, dataVersion:'999'}), 800); },
            getUserListData: function() { setTimeout(()=>this.s({success:true, list:[['a@x.com','Aã•ã‚“','å–¶æ¥­éƒ¨'],['b@x.com','Bã•ã‚“','é–‹ç™ºéƒ¨']], from:'Mock'}), 500); },
            sendAirCoin: function() { setTimeout(()=>this.s({success:true, message:'Mock Sent', newBalance:70, dailySent:6}), 800); },
            getRankings: function() { setTimeout(()=>this.s({rankings:{mvp:[], dept:[]}}), 500); },
            getUserHistory: function() { setTimeout(()=>this.s({history:[]}), 500); }
         }}};
      }

      let currentUser = null;
      let allUsers = []; // [{email, name, dept}, ...]
      let appConfig = {};
      let sendAmount = 1;
      const RANK_MAP = { 'ç´ æµªäºº': 'ğŸ¥º', 'ä¸ç¨š': 'ğŸ£', 'å•†äºº': 'ğŸ‘˜', 'è±ªå•†': 'ğŸ¯', 'å¤©ä¸‹äºº': 'ğŸ‘‘' };

      window.onload = () => handleLogin();

      function handleLogin() {
        showLoading(true);
        google.script.run.withSuccessHandler(initSuccess).withFailureHandler(initFail).getInitialData();
      }

      function initSuccess(data) {
        showLoading(false);
        if (data.error === 'NOT_REGISTERED') {
          renderDeptOptions(data.departments);
          document.getElementById('view-auth').classList.add('hidden');
          document.getElementById('view-register').classList.remove('hidden');
        } else if (data.success) {
          // 1. æœ€å„ªå…ˆã§UIæç”» (è‡ªåˆ†ã®æƒ…å ±ã¯ã™ã§ã«ã‚ã‚‹)
          currentUser = data.user;
          appConfig = data.config;
          updateUI();
          updateEconomyUI(data.economy);
          
          document.getElementById('view-auth').classList.add('hidden');
          document.getElementById('view-app').classList.remove('hidden');
          document.getElementById('headerWallet').classList.remove('hidden');
          document.getElementById('bottomNav').classList.remove('hidden');
          switchTab('tab-home');

          // 2. é…å»¶èª­ã¿è¾¼ã¿ & localStorageåŒæœŸ (é‡ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ)
          syncUserList(data.dataVersion);
        }
      }

      function initFail(e) { showLoading(false); alert('Error: ' + e.message); }

      // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ (localStorage)
      function syncUserList(serverVersion) {
        const localVersion = localStorage.getItem('EYAN_DATA_VERSION');
        const localData = localStorage.getItem('EYAN_USER_LIST');

        if (localVersion === serverVersion && localData) {
           console.log('Using Local Cache');
           parseAndSetUsers(JSON.parse(localData));
        } else {
           console.log('Fetching New Data...');
           // ãƒªã‚¹ãƒˆå–å¾— (éåŒæœŸ)
           google.script.run.withSuccessHandler(res => {
              if (res.success) {
                 // ä¿å­˜ (Arrayå½¢å¼ã®ã¾ã¾ä¿å­˜ã—ã¦å®¹é‡ç¯€ç´„)
                 localStorage.setItem('EYAN_DATA_VERSION', serverVersion);
                 localStorage.setItem('EYAN_USER_LIST', JSON.stringify(res.list));
                 parseAndSetUsers(res.list);
              }
           }).getUserListData();
        }
      }

      // é…åˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦ãƒ¡ãƒ¢ãƒªå±•é–‹
      function parseAndSetUsers(listArray) {
        // [email, name, dept] -> {email, name, dept}
        allUsers = listArray.map(row => ({
          email: row[0],
          name: row[1],
          department: row[2]
        }));
        console.log('User List Loaded:', allUsers.length);
        renderRecipientOptions(allUsers);
      }

      function updateUI() {
        if(!currentUser) return;
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userDept').textContent = currentUser.department;
        document.getElementById('userRank').textContent = currentUser.rank;
        document.getElementById('rankAvatar').textContent = RANK_MAP[currentUser.rank] || 'ğŸ¥º';
        if (currentUser.isMVP) document.getElementById('mvpCrown').classList.remove('hidden');
        document.getElementById('walletBalance').textContent = currentUser.wallet_balance;
        const pct = Math.min((currentUser.wallet_balance / appConfig.INITIAL_COIN) * 100, 100);
        document.getElementById('coinProgressBar').style.width = pct + '%';
        document.getElementById('progressText').textContent = `ã‚ã¨${currentUser.wallet_balance}æš`;
        document.getElementById('dailySentCount').textContent = currentUser.dailySent;
      }

      function updateEconomyUI(level) {
        const body = document.body;
        const txt = document.getElementById('economyStatusText');
        const icon = document.getElementById('economyIcon');
        body.className = "min-h-screen text-gray-800 font-sans transition-colors duration-1000";
        if (level === 'level3') { 
          body.classList.add('bg-gradient-to-br', 'from-pink-50', 'to-rose-100');
          txt.innerHTML = '<span class="text-pink-600">å¥½æ™¯æ°— (Lv.3)</span>'; icon.textContent = 'ğŸ‰';
        } else if (level === 'level2') {
          body.classList.add('bg-gradient-to-br', 'from-purple-50', 'to-indigo-100');
          txt.innerHTML = '<span class="text-indigo-600">é€šå¸¸ (Lv.2)</span>'; icon.textContent = 'ğŸ¢';
        } else {
          body.classList.add('bg-gradient-to-br', 'from-sky-50', 'to-blue-100');
          txt.innerHTML = '<span class="text-blue-600">ä¸æ³ (Lv.1)</span>'; icon.textContent = 'ğŸƒ';
        }
      }

      function switchTab(tabId) {
        ['tab-home', 'tab-send', 'tab-ranking', 'tab-history'].forEach(id => document.getElementById(id).classList.add('hidden'));
        ['nav-home', 'nav-send', 'nav-ranking', 'nav-history'].forEach(id => {
          const el = document.getElementById(id);
          el.classList.remove('tab-active'); el.classList.add('tab-inactive');
          el.querySelector('i').classList.remove('text-indigo-600');
        });
        document.getElementById(tabId).classList.remove('hidden');
        const active = document.getElementById(tabId.replace('tab', 'nav'));
        active.classList.add('tab-active'); active.classList.remove('tab-inactive');
        active.querySelector('i').classList.add('text-indigo-600');

        if (tabId === 'tab-ranking') loadRankings();
        if (tabId === 'tab-history') loadHistory();
      }

      function stepAmount(diff) {
        let next = sendAmount + diff;
        if (next < 1) next = 1; if (next > 10) next = 10;
        sendAmount = next;
        document.getElementById('displayAmount').textContent = sendAmount;
        updateEstimation();
      }
      function addTag(t) { const a=document.getElementById('messageInput'); a.value=(a.value+' '+t).trim(); }
      
      function filterRecipients() {
        const val = document.getElementById('recipientSearch').value.toLowerCase();
        const filtered = val ? allUsers.filter(u=>u.name.toLowerCase().includes(val)||u.department.toLowerCase().includes(val)) : allUsers;
        renderRecipientOptions(filtered);
      }
      function renderRecipientOptions(list) {
        const sel = document.getElementById('recipientSelect');
        sel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        const grps = {};
        list.forEach(u=>{ if(!grps[u.department]) grps[u.department]=[]; grps[u.department].push(u); });
        Object.keys(grps).forEach(d=>{
           const g = document.createElement('optgroup'); g.label=d;
           grps[d].forEach(u=>{ const o=document.createElement('option'); o.value=u.email; o.textContent=u.name; g.appendChild(o); });
           sel.appendChild(g);
        });
      }
      function updateEstimation() {
         const email = document.getElementById('recipientSelect').value;
         const box = document.getElementById('estimationBox');
         if(!email) { box.classList.add('hidden'); return; }
         const t = allUsers.find(u=>u.email===email);
         if(!t) return;
         const same = t.department === currentUser.department;
         const m = same ? 1 : (appConfig.MULTIPLIER_DIFF_DEPT||1.5);
         const g = Math.floor(sendAmount * m);
         box.classList.remove('hidden');
         document.getElementById('estimationResult').textContent = same ? `åŒéƒ¨ç½²: ç›¸æ‰‹ã« ${g} pt` : `ä»–éƒ¨ç½²: ç›¸æ‰‹ã« ${g} pt (${m}å€!)`;
      }
      function submitSend() {
         const email = document.getElementById('recipientSelect').value;
         const msg = document.getElementById('messageInput').value;
         if(!email || !msg) return alert('å…¥åŠ›ä¸å‚™ã‚ã‚Š');
         if(!confirm(`${sendAmount}æšé€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ`)) return;
         
         const btn = document.getElementById('sendBtn'); btn.disabled=true;
         google.script.run.withSuccessHandler(res=>{
            btn.disabled=false;
            if(res.success) {
               showToast('é€ä¿¡å®Œäº†', res.message);
               currentUser.wallet_balance = res.newBalance;
               currentUser.dailySent = res.dailySent;
               updateUI();
               document.getElementById('messageInput').value='';
               document.getElementById('recipientSelect').value='';
               switchTab('tab-home');
            } else alert(res.message);
         }).withFailureHandler(e=>{ btn.disabled=false; alert(e.message); }).sendAirCoin(email, msg, sendAmount);
      }

      function loadRankings() { google.script.run.withSuccessHandler(r=>{ if(r.success) renderRankings(r.rankings); }).getRankings(); }
      function renderRankings(d) {
         const m=document.getElementById('mvpList'); m.innerHTML='';
         d.mvp.forEach((u,i)=>{
            const ic=i<3?['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]:i+1;
            m.innerHTML+=`<div class="flex justify-between p-2 border-b border-gray-100"><div class="flex gap-2 w-full"><span class="w-6 text-center">${ic}</span><div><p class="text-xs font-bold">${u.name}</p><p class="text-[10px] text-gray-400">${u.dept}</p></div></div><div class="text-sm font-bold text-indigo-600">${u.score}</div></div>`;
         });
         const dp=document.getElementById('deptList'); dp.innerHTML='';
         const max=d.dept[0]?d.dept[0].score:1;
         d.dept.forEach(x=>{
            const p=(x.score/max)*100;
            dp.innerHTML+=`<div class="mb-2"><div class="flex justify-between text-xs mb-1"><span class="font-bold">${x.name}</span><span class="text-indigo-500">${x.score}</span></div><div class="bg-gray-100 rounded-full h-1.5"><div class="bg-indigo-400 h-1.5 rounded-full" style="width:${p}%"></div></div></div>`;
         });
      }
      function loadHistory() { google.script.run.withSuccessHandler(r=>{ if(r.success) renderHistory(r.history); }).getUserHistory(); }
      function renderHistory(h) {
         const c=document.getElementById('historyContainer'); c.innerHTML='';
         if(h.length===0) return c.innerHTML='<p class="text-center text-gray-400 text-xs">å±¥æ­´ãªã—</p>';
         h.forEach(x=>{
            const d=new Date(x.timestamp);
            const ds=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
            c.innerHTML+=`<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100"><div class="flex justify-between"><div><p class="text-[10px] text-gray-400">${ds}</p><p class="text-sm font-bold">${x.sender_id}</p></div><p class="text-lg font-bold text-indigo-600">+${x.value}</p></div><p class="text-xs bg-gray-50 p-2 mt-1 rounded">${x.message}</p></div>`;
         });
      }
      function renderDeptOptions(l) { const s=document.getElementById('registerDeptSelect'); s.innerHTML=''; l.forEach(d=>{const o=document.createElement('option'); o.value=d; o.textContent=d; s.appendChild(o);}); }
      function handleRegister(e) { e.preventDefault(); showLoading(true); google.script.run.withSuccessHandler(r=>{ if(r.success) handleLogin(); }).registerNewUser({name:e.target.name.value, department:e.target.department.value}); }
      function showToast(t,m) { const e=document.getElementById('toast'); document.getElementById('toastTitle').textContent=t; document.getElementById('toastMsg').textContent=m; e.classList.remove('hidden','toast-enter'); void e.offsetWidth; e.classList.add('toast-enter'); setTimeout(()=>e.classList.add('hidden'), 4000); }
      function showLoading(b) { const e=document.getElementById('loadingOverlay'); b?e.classList.remove('hidden'):e.classList.add('hidden'); }
    </script>
  </body>
</html>
